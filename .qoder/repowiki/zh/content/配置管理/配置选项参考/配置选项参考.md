# 配置选项参考

<cite>
**本文档中引用的文件**   
- [apk.c](file://src/apk.c)
- [apk_defines.h](file://src/apk_defines.h)
- [apk_context.h](file://src/apk_context.h)
</cite>

## 目录
1. [全局配置选项](#全局配置选项)
2. [force标志与常规标志的区别](#force标志与常规标志的区别)
3. [底层实现机制](#底层实现机制)

## 全局配置选项

以下为基于`src/apk.c`中`GLOBAL_OPTIONS`宏定义的全局配置选项详细说明。

### --root
- **功能描述**：指定目标根文件系统路径，用于在非默认根目录下操作。
- **默认值**：系统根目录（/）
- **取值范围**：合法的文件系统路径
- **使用示例**：`apk --root /mnt/chroot add nginx`

### --cache-dir
- **功能描述**：设置包缓存目录，用于存储下载的包文件。
- **默认值**：/var/cache/apk
- **取值范围**：合法的文件系统路径
- **使用示例**：`apk --cache-dir /tmp/apk-cache list`

### --repositories-file
- **功能描述**：指定仓库配置文件路径，用于加载自定义软件源列表。
- **默认值**：/etc/apk/repositories
- **取值范围**：合法的文件路径
- **使用示例**：`apk --repositories-file /custom/repo.conf update`

### --timeout
- **功能描述**：设置网络请求超时时间（秒）。
- **默认值**：60秒
- **取值范围**：正整数
- **使用示例**：`apk --timeout 30 fetch busybox`

### --force
- **功能描述**：启用多个强制模式，包括覆盖文件、旧APK兼容、非仓库安装和二进制输出。
- **默认值**：禁用
- **使用示例**：`apk --force install package.apk`

### --force-overwrite
- **功能描述**：强制覆盖已存在的文件。
- **默认值**：禁用
- **使用场景**：当需要替换系统中已存在的文件时使用。

### --force-refresh
- **功能描述**：强制刷新仓库索引，忽略本地缓存。
- **默认值**：禁用
- **使用场景**：当仓库内容已更新但本地缓存未同步时使用。

### --no-network
- **功能描述**：禁用网络访问，仅使用本地缓存或已下载的包。
- **默认值**：启用网络
- **使用场景**：离线环境或测试本地包安装。

### --interactive
- **功能描述**：启用交互模式，在关键操作前提示用户确认。
- **默认值**：根据系统配置自动判断
- **使用场景**：生产环境中的安全操作。

### --no-interactive
- **功能描述**：禁用交互模式，所有操作自动执行。
- **默认值**：根据系统配置自动判断
- **使用场景**：脚本自动化部署。

### --arch
- **功能描述**：指定目标架构，用于多架构环境。
- **默认值**：当前系统架构
- **取值范围**：支持的架构名称（如x86_64, armhf等）
- **使用示例**：`apk --arch armhf add package`

### --cache-max-age
- **功能描述**：设置缓存最大存活时间（分钟）。
- **默认值**：无限制
- **取值范围**：非负整数
- **使用示例**：`apk --cache-max-age 1440 update`

### --update-cache
- **功能描述**：强制更新包索引缓存。
- **默认值**：根据缓存状态自动判断
- **使用场景**：等同于`apk update`命令。

**Section sources**
- [apk.c](file://src/apk.c#L38-L78)
- [apk.c](file://src/apk.c#L83-L210)

## force标志与常规标志的区别

### force标志
force标志主要用于处理异常情况和强制执行特定行为，通常涉及数据覆盖、安全策略绕过等高风险操作。这些标志通过`ac->force`位域进行管理。

**主要force标志包括**：
- `APK_FORCE_OVERWRITE`：文件覆盖
- `APK_FORCE_REFRESH`：强制刷新
- `APK_FORCE_NON_REPOSITORY`：非仓库安装
- `APK_FORCE_OLD_APK`：旧版本兼容

**应用场景**：
- 系统恢复时强制覆盖关键文件
- 网络环境异常时强制使用本地资源
- 兼容旧版本包格式

### 常规标志
常规标志用于控制程序的常规行为和功能开关，通过`ac->flags`位域管理。

**主要常规标志包括**：
- `APK_NO_NETWORK`：禁用网络
- `APK_INTERACTIVE`：交互模式
- `APK_NO_CHROOT`：禁用chroot
- `APK_PURGE`：完全删除

**应用场景**：
- 自动化脚本中禁用交互提示
- 特殊环境下的网络限制
- 安全策略的临时调整

**关键区别**：
1. **风险等级**：force标志通常具有更高风险，可能破坏系统完整性
2. **使用频率**：常规标志更常用于日常操作
3. **组合使用**：多个force标志可组合使用以应对复杂场景

**Section sources**
- [apk.c](file://src/apk.c#L113-L140)
- [apk_context.h](file://src/apk_context.h#L23-L37)

## 底层实现机制

### 位标志定义
在`apk_defines.h`中，使用`BIT(x)`宏定义位标志，每个标志对应一个唯一的位位置。

```c
#define APK_FORCE_OVERWRITE		BIT(0)
#define APK_FORCE_OLD_APK		BIT(1)
#define APK_FORCE_REFRESH		BIT(3)
#define APK_INTERACTIVE			BIT(5)
#define APK_NO_NETWORK			BIT(6)
```

### 上下文结构
`struct apk_ctx`结构体中包含两个关键位域：
- `force`：用于force标志
- `flags`：用于常规标志

```c
struct apk_ctx {
    unsigned int flags, force, open_flags;
    // 其他成员...
};
```

### 标志解析流程
1. **选项解析**：`optgroup_global_parse`函数处理命令行参数
2. **位设置**：使用按位或操作（|=）设置相应标志位
3. **条件判断**：在执行过程中检查标志位状态

### 宏定义机制
- `APK_OPT_BOOL`：处理布尔选项
- `APK_OPT_ARG`：处理带参数选项
- `APK_OPT_SH`：定义短选项

### 选项分组
通过`APK_OPTIONS`宏实现选项分组管理：
```c
#define GLOBAL_OPTIONS(OPT) \
    OPT(OPT_GLOBAL_root, "root") \
    OPT(OPT_GLOBAL_cache_dir, "cache-dir")
```

**Section sources**
- [apk_defines.h](file://src/apk_defines.h#L23)
- [apk_context.h](file://src/apk_context.h#L64-L97)
- [apk.c](file://src/apk.c#L319-L322)