# 安装与构建

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [meson_options.txt](file://meson_options.txt)
- [scripts/generate-meson-crossfile.sh](file://scripts/generate-meson-crossfile.sh)
- [src/Makefile](file://src/Makefile)
- [Makefile](file://Makefile)
</cite>

## 目录
1. [简介](#简介)
2. [构建系统概述](#构建系统概述)
3. [Meson构建系统](#meson构建系统)
4. [传统Makefile系统](#传统makefile系统)
5. [静态编译配置](#静态编译配置)
6. [构建选项详解](#构建选项详解)
7. [交叉编译指南](#交叉编译指南)
8. [从源码构建步骤](#从源码构建步骤)
9. [常见构建错误及解决方案](#常见构建错误及解决方案)
10. [总结](#总结)

## 简介

`apk-tools` 是 Alpine Linux 使用的包管理工具，也被其他多个发行版采用。本文档详细介绍了其安装与构建流程，重点说明使用 Meson 构建系统的现代方法，并涵盖传统 Makefile 系统的使用（即将弃用）。同时提供静态编译、构建选项配置和交叉编译的完整指导。

**Section sources**
- [README.md](file://README.md#L1-L36)

## 构建系统概述

`apk-tools` 支持两种构建方式：推荐使用的 **Meson** 构建系统和即将弃用的 **Makefile** 构建系统。Meson 提供更灵活的配置选项和跨平台支持，而 Makefile 仅适用于 musl-linux 目标平台，并将在未来版本中移除。

**Section sources**
- [README.md](file://README.md#L6-L28)

## Meson构建系统

Meson 是当前推荐的构建方式，具有良好的可移植性和配置灵活性。

### 基本构建流程

使用 Meson 构建 `apk-tools` 的标准命令如下：

```bash
meson setup -Dprefix=/ build
ninja -C build
meson install -C build
```

此流程会创建一个名为 `build` 的构建目录，并在其中完成配置、编译和安装过程。

### 静态构建

要构建静态链接的 `apk` 二进制文件，需传递特定参数：

```bash
meson setup -Dc_link_args="-static" -Dprefer_static=true -Ddefault_library=static build
ninja -C build src/apk
```

这将生成位于 `./build/src/apk` 的完全静态链接的二进制文件，便于在无依赖环境中部署。

**Section sources**
- [README.md](file://README.md#L8-L25)

## 传统Makefile系统

尽管 Meson 是首选构建系统，但项目仍保留了传统的 Makefile 构建方式，主要用于引导场景或不支持 Python 的环境。

### 使用限制

- 仅支持 musl-libc 的 Linux 目标平台
- 已标记为即将弃用，将在 `apk-tools 3.0` 版本中移除
- 功能不如 Meson 系统完整

### 构建命令

```bash
make
make install
```

可通过设置环境变量来自定义构建行为，如 `URL_BACKEND` 和 `CRYPTO`。

**Section sources**
- [README.md](file://README.md#L27-L28)
- [Makefile](file://Makefile#L39-L41)
- [src/Makefile](file://src/Makefile#L1-L126)

## 静态编译配置

静态编译可生成不依赖外部共享库的独立二进制文件，适用于容器镜像、嵌入式系统等场景。

### 配置参数

| 参数 | 说明 |
|------|------|
| `-Dc_link_args="-static"` | 传递给链接器的静态链接标志 |
| `-Dprefer_static=true` | 优先使用静态库进行链接 |
| `-Ddefault_library=static` | 默认构建静态库而非共享库 |

### 优势

- 无需安装额外的运行时依赖
- 更小的部署包体积（无需包含依赖库）
- 更高的可移植性
- 更强的安全性（减少攻击面）

**Section sources**
- [README.md](file://README.md#L18-L25)

## 构建选项详解

`meson_options.txt` 文件定义了所有可用的构建时配置选项。

### 核心构建选项

```meson
option('arch', description: 'Specify a custom arch', type: 'string')
option('crypto_backend', description: 'Crypto backend', type: 'combo', choices: ['openssl', 'mbedtls'], value: 'openssl')
option('url_backend', description: 'URL backend', type: 'combo', choices: ['libfetch', 'wget'], value: 'libfetch')
option('zstd', description: 'Build with zstd support', type: 'boolean', value: true)
```

### 选项说明

| 选项 | 类型 | 默认值 | 影响 |
|------|------|--------|------|
| `arch` | 字符串 | 无 | 指定自定义目标架构 |
| `crypto_backend` | 组合 | openssl | 选择加密后端（openssl/mbedtls） |
| `url_backend` | 组合 | libfetch | 选择 URL 下载后端 |
| `zstd` | 布尔值 | true | 是否启用 Zstandard 压缩支持 |
| `help` | 特性 | auto | 是否将帮助文档编译进二进制文件 |
| `docs` | 特性 | auto | 是否使用 scdoc 生成手册页 |
| `lua` | 特性 | auto | 是否构建 Lua 绑定 |
| `python` | 特性 | auto | 是否构建 Python 绑定 |

这些选项直接影响最终二进制文件的功能集、依赖关系和性能特征。

**Section sources**
- [meson_options.txt](file://meson_options.txt#L1-L16)

## 交叉编译指南

`scripts/generate-meson-crossfile.sh` 脚本用于生成 Meson 交叉编译配置文件。

### 使用方法

1. 设置必要的环境变量：
   ```bash
   export CARCH=aarch64
   export CC=aarch64-linux-gnu-gcc
   export CXX=aarch64-linux-gnu-g++
   export CFLAGS="-O2 -pipe"
   export LDFLAGS="-Wl,-O1"
   ```

2. 生成交叉编译文件：
   ```bash
   ./scripts/generate-meson-crossfile.sh
   ```

3. 使用交叉文件构建：
   ```bash
   meson setup --cross-file apk.cross build
   ninja -C build
   ```

### 支持的架构

脚本自动识别以下架构：
- MIPS（大端/小端）
- ARM
- AArch64
- x86/x86_64
- PowerPC 64 位小端

脚本根据 `CARCH` 环境变量自动推断目标架构的 CPU 家族和字节序。

**Section sources**
- [scripts/generate-meson-crossfile.sh](file://scripts/generate-meson-crossfile.sh#L1-L51)

## 从源码构建步骤

### 完整构建流程

1. **克隆仓库**
   ```bash
   git clone https://gitlab.alpinelinux.org/alpine/apk-tools.git
   cd apk-tools
   ```

2. **安装依赖**
   - Meson
   - Ninja
   - GCC 或 Clang
   - pkg-config
   - OpenSSL 或 mbedTLS 开发库
   - zlib 开发库
   - libzstd 开发库（可选）

3. **配置构建**
   ```bash
   meson setup -Dprefix=/usr -Dcrypto_backend=openssl build
   ```

4. **编译**
   ```bash
   ninja -C build
   ```

5. **测试**
   ```bash
   ninja -C build test
   ```

6. **安装**
   ```bash
   sudo meson install -C build
   ```

### 构建变体

- **开发构建**：`meson setup -Dbuildtype=debug build`
- **发布构建**：`meson setup -Dbuildtype=release build`
- **最小化构建**：`meson setup -Dhelp=disabled -Ddocs=disabled build`

**Section sources**
- [README.md](file://README.md#L8-L25)
- [meson_options.txt](file://meson_options.txt#L1-L16)

## 常见构建错误及解决方案

### 1. 缺少依赖库

**错误信息**：
```
Pkg-config not found for 'openssl'
```

**解决方案**：
安装相应的开发包：
```bash
# Alpine Linux
apk add openssl-dev pkgconfig

# Ubuntu/Debian
apt-get install libssl-dev pkg-config
```

### 2. 交叉编译工具链未找到

**错误信息**：
```
Could not execute C compiler
```

**解决方案**：
确保正确设置 `CC` 环境变量并安装目标平台的工具链：
```bash
export CC=aarch64-linux-gnu-gcc
sudo apt-get install gcc-aarch64-linux-gnu
```

### 3. Lua 相关构建失败

**错误信息**：
```
Lua not found, disabling lua bindings
```

**解决方案**：
- 安装 Lua 开发库：`apk add lua5.3-dev`
- 或禁用 Lua 支持：`-Dlua=disabled`

### 4. 静态构建失败

**错误信息**：
```
cannot find -lssl
```

**解决方案**：
确保安装静态库版本：
```bash
apk add openssl-static
```

或使用动态构建：
```bash
meson setup -Ddefault_library=shared build
```

**Section sources**
- [README.md](file://README.md#L8-L25)
- [meson_options.txt](file://meson_options.txt#L1-L16)
- [scripts/generate-meson-crossfile.sh](file://scripts/generate-meson-crossfile.sh#L1-L51)

## 总结

`apk-tools` 的构建系统已全面转向 Meson，提供了更现代化、灵活和可维护的构建体验。用户应优先使用 Meson 进行构建，避免依赖即将弃用的 Makefile 系统。通过合理配置 `meson_options.txt` 中的选项，可以精确控制最终二进制文件的功能和特性。静态编译和交叉编译功能使得 `apk-tools` 能够适应各种部署环境，从容器到嵌入式设备。

**Section sources**
- [README.md](file://README.md#L1-L36)
- [meson_options.txt](file://meson_options.txt#L1-L16)